<!DOCTYPE html>
<html lang="ja" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Driven Analytics - Enhanced Mock</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <style>
    /* === CSS Variables (same as production) === */
    :root {
      --bg-base: #0f172a;
      --bg-card: #1e293b;
      --bg-card-hover: #263347;
      --bg-sidebar: #1a2236;
      --bg-input: #334155;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-light: rgba(59, 130, 246, 0.15);
      --border: #334155;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --purple: #a855f7;
      --chart-opus: #8b5cf6;
      --chart-sonnet: #3b82f6;
      --chart-haiku: #22d3ee;
      --sidebar-width: 220px;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --shadow-card: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
      --shadow-card-hover: 0 8px 24px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.3);
      --transition-fast: 0.15s ease;
      --transition-normal: 0.25s ease;
    }

    /* === Reset & Base === */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 14px; scroll-behavior: smooth; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans JP", sans-serif;
      background-color: var(--bg-base);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }
    a { color: var(--accent); text-decoration: none; }

    /* === Layout === */
    .page-layout { display: flex; min-height: 100vh; }
    .sidebar {
      width: var(--sidebar-width); background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      position: fixed; top: 0; left: 0; bottom: 0;
      display: flex; flex-direction: column; z-index: 100;
    }
    .sidebar-header { padding: 20px 16px; border-bottom: 1px solid var(--border); }
    .sidebar-logo { display: flex; align-items: baseline; gap: 6px; }
    .sidebar-logo-mark { font-size: 18px; font-weight: 800; color: var(--accent); letter-spacing: -1px; }
    .sidebar-logo-text { font-size: 11px; font-weight: 500; color: var(--text-muted); letter-spacing: 0.5px; text-transform: uppercase; }
    .sidebar-nav { flex: 1; padding: 12px 0; overflow-y: auto; }
    .sidebar-nav a {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 16px; color: var(--text-secondary);
      font-size: 13px; font-weight: 500;
      transition: all var(--transition-fast);
      border-left: 3px solid transparent; cursor: pointer;
    }
    .sidebar-nav a:hover { color: var(--text-primary); background: rgba(255,255,255,0.04); }
    .sidebar-nav a.active { color: var(--accent); background: var(--accent-light); border-left-color: var(--accent); }

    /* Sidebar section labels */
    .sidebar-section {
      font-size: 10px; font-weight: 700; letter-spacing: 1.5px;
      text-transform: uppercase; color: var(--text-muted);
      padding: 16px 16px 4px; margin-top: 4px;
    }
    .sidebar-section:first-child { margin-top: 0; }
    .sidebar-section .persona-dot {
      display: inline-block; width: 6px; height: 6px; border-radius: 50%;
      margin-right: 4px; vertical-align: middle;
    }
    .sidebar-section .persona-dot.team { background: var(--accent); }
    .sidebar-section .persona-dot.personal { background: var(--success); }

    /* Sidebar filter section */
    .sidebar-filters { padding: 16px; border-top: 1px solid var(--border); }
    .sidebar-filters label {
      display: block; font-size: 10px; font-weight: 700;
      letter-spacing: 1px; text-transform: uppercase;
      color: var(--text-muted); margin-bottom: 4px; margin-top: 10px;
    }
    .sidebar-filters label:first-child { margin-top: 0; }
    .sidebar-filters select, .sidebar-filters input[type="date"] {
      width: 100%; background: var(--bg-input); border: 1px solid var(--border);
      color: var(--text-primary); padding: 6px 8px; border-radius: var(--radius-sm);
      font-size: 12px; outline: none;
    }
    .filter-saved-badge {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 10px; color: var(--success); margin-top: 8px;
    }
    .filter-saved-dot {
      width: 6px; height: 6px; border-radius: 50%; background: var(--success);
    }

    .main-content { flex: 1; margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; }
    .page-header { padding: 20px 28px 0; }
    .page-header h1 { font-size: 22px; font-weight: 700; }
    .page-header p { font-size: 13px; color: var(--text-secondary); }
    .page-body { padding: 20px 28px 40px; flex: 1; }

    /* Breadcrumb */
    .breadcrumb {
      display: flex; align-items: center; gap: 6px;
      font-size: 12px; color: var(--text-muted); margin-bottom: 4px;
    }
    .breadcrumb a { color: var(--text-muted); cursor: pointer; }
    .breadcrumb a:hover { color: var(--accent); }
    .breadcrumb .sep { color: var(--text-muted); }

    /* === Buttons === */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 7px 14px; font-size: 13px; font-weight: 600;
      border: none; border-radius: var(--radius-sm);
      cursor: pointer; transition: all var(--transition-fast);
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
    .btn-ghost:hover { color: var(--text-primary); border-color: var(--text-muted); }

    /* === Cards === */
    .card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-md); box-shadow: var(--shadow-card);
    }
    .card-header {
      padding: 16px 20px 12px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .card-title { font-size: 14px; font-weight: 700; }
    .card-body { padding: 20px; }

    /* === KPI Cards === */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
    .kpi-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 20px;
      box-shadow: var(--shadow-card);
      transition: box-shadow var(--transition-normal), transform var(--transition-normal);
      border-top: 3px solid var(--border);
    }
    .kpi-card:hover { box-shadow: var(--shadow-card-hover); transform: translateY(-2px); }
    .kpi-card.blue   { border-top-color: #3b82f6; }
    .kpi-card.green  { border-top-color: #22c55e; }
    .kpi-card.purple { border-top-color: #8b5cf6; }
    .kpi-card.amber  { border-top-color: #f59e0b; }
    .kpi-card.cyan   { border-top-color: #06b6d4; }
    .kpi-label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-value { font-size: 28px; font-weight: 800; line-height: 1.2; margin-top: 4px; }
    .kpi-sub { font-size: 11px; color: var(--text-muted); margin-top: 6px; }
    .kpi-trend { display: inline-flex; align-items: center; gap: 3px; font-size: 12px; font-weight: 600; margin-top: 6px; }
    .kpi-trend.up-good { color: var(--success); }
    .kpi-trend.up-bad { color: var(--danger); }
    .kpi-trend.down-good { color: var(--success); }
    .kpi-trend.down-bad { color: var(--danger); }
    .kpi-trend.neutral { color: var(--text-muted); }

    /* === Grids === */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .grid-1 { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }

    /* === Hint Card === */
    .hint-card {
      background: rgba(59, 130, 246, 0.06);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: var(--radius-md);
      padding: 14px 20px; margin-bottom: 20px;
      display: flex; align-items: flex-start; gap: 12px;
    }
    .hint-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; color: var(--accent); }
    .hint-body { flex: 1; }
    .hint-title { font-size: 12px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .hint-text { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
    .hint-link { font-size: 12px; color: var(--accent); cursor: pointer; margin-top: 4px; display: inline-block; }
    .hint-card.warning {
      background: rgba(245, 158, 11, 0.06);
      border-color: rgba(245, 158, 11, 0.2);
    }
    .hint-card.warning .hint-icon,
    .hint-card.warning .hint-title { color: var(--warning); }

    /* === Inline AI Insight Panel (page-integrated) === */
    .ai-insight {
      background: linear-gradient(135deg, rgba(139,92,246,0.06), rgba(59,130,246,0.06));
      border: 1px solid rgba(139,92,246,0.2);
      border-radius: var(--radius-md);
      margin-bottom: 20px; overflow: hidden;
    }
    .ai-insight-header {
      padding: 14px 20px; display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid rgba(139,92,246,0.15);
    }
    .ai-insight-label {
      font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
      background: linear-gradient(135deg, #a78bfa, #60a5fa);
      background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .ai-insight-badge {
      font-size: 10px; padding: 2px 8px; border-radius: 999px;
      background: rgba(139,92,246,0.15); color: #a78bfa; font-weight: 600;
    }
    .ai-insight-body { padding: 16px 20px; }
    .ai-insight-body p { font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 10px; }
    .ai-insight-body p:last-child { margin-bottom: 0; }
    .ai-insight-body strong { color: var(--text-primary); }
    .ai-insight-body ul { padding-left: 18px; margin: 8px 0; }
    .ai-insight-body li { font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 4px; }
    .ai-insight-actions {
      padding: 12px 20px; border-top: 1px solid rgba(139,92,246,0.15);
      display: flex; gap: 8px;
    }
    .ai-insight-actions button {
      padding: 6px 12px; font-size: 12px; font-weight: 600;
      border-radius: var(--radius-sm); cursor: pointer;
      border: 1px solid rgba(139,92,246,0.3); background: rgba(139,92,246,0.08);
      color: #a78bfa; transition: all var(--transition-fast);
    }
    .ai-insight-actions button:hover { background: rgba(139,92,246,0.15); }

    /* === Data Table === */
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table thead th {
      background: rgba(51,65,85,0.5); padding: 10px 14px; text-align: left;
      font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;
      color: var(--text-muted); border-bottom: 1px solid var(--border); white-space: nowrap;
    }
    .data-table tbody tr { border-bottom: 1px solid var(--border); transition: background var(--transition-fast); }
    .data-table tbody tr:hover { background: rgba(59,130,246,0.06); }
    .data-table tbody td { padding: 10px 14px; vertical-align: middle; }
    .data-table .text-right { text-align: right; }
    .text-muted { color: var(--text-muted); }
    .font-mono { font-family: "SF Mono", "Fira Code", monospace; }

    /* === Badges === */
    .badge { display: inline-block; padding: 2px 8px; font-size: 11px; font-weight: 600; border-radius: 999px; line-height: 1.6; white-space: nowrap; }
    .badge-opus   { background: rgba(139,92,246,0.18); color: #a78bfa; }
    .badge-sonnet { background: rgba(59,130,246,0.18);  color: #60a5fa; }
    .badge-haiku  { background: rgba(34,211,238,0.18); color: #22d3ee; }
    .badge-success { background: rgba(34,197,94,0.18);  color: #22c55e; }
    .badge-warning { background: rgba(245,158,11,0.18); color: #f59e0b; }
    .badge-danger  { background: rgba(239,68,68,0.18);  color: #ef4444; }
    .badge-info    { background: rgba(6,182,212,0.18);   color: #06b6d4; }

    /* === Trend arrows in tables === */
    .trend-up { color: var(--success); font-size: 12px; font-weight: 600; }
    .trend-down { color: var(--danger); font-size: 12px; font-weight: 600; }
    .trend-flat { color: var(--text-muted); font-size: 12px; }

    /* === Tabs === */
    .tab-bar {
      display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 20px;
    }
    .tab-btn {
      padding: 10px 20px; font-size: 13px; font-weight: 600;
      color: var(--text-muted); background: none; border: none;
      cursor: pointer; border-bottom: 2px solid transparent;
      margin-bottom: -2px; transition: all var(--transition-fast);
    }
    .tab-btn:hover { color: var(--text-primary); }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* === Scatter classification legend === */
    .classification-bar {
      display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
    }
    .class-item {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 12px 16px;
      flex: 1; min-width: 150px; cursor: pointer;
      transition: all var(--transition-fast);
    }
    .class-item:hover { border-color: var(--accent); }
    .class-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .class-info { flex: 1; }
    .class-name { font-size: 12px; font-weight: 700; color: var(--text-primary); }
    .class-pct { font-size: 18px; font-weight: 800; color: var(--text-primary); }
    .class-desc { font-size: 11px; color: var(--text-muted); }

    /* === Chart container === */
    .chart-container { position: relative; }
    .chart-container canvas { width: 100% !important; }

    /* === Heatmap === */
    .heatmap-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .heatmap-table th, .heatmap-table td { border: 2px solid var(--bg-card); text-align: center; padding: 6px 2px; min-width: 28px; }
    .heatmap-table thead th { background: transparent; color: var(--text-muted); font-weight: 600; font-size: 10px; padding-bottom: 8px; border: none; }
    .heatmap-table td.day-label { background: transparent; color: var(--text-secondary); font-weight: 600; text-align: right; padding-right: 10px; border: none; }
    .heatmap-table td.cell { border-radius: 3px; }

    /* === View container === */
    .view { display: none; }
    .view.active { display: block; }

    /* === AI Analyst Floating Button === */
    .ai-fab {
      position: fixed; bottom: 24px; right: 24px; z-index: 200;
      width: 52px; height: 52px; border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #3b82f6);
      border: none; color: #fff; font-size: 20px; font-weight: 700;
      cursor: pointer; box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
      transition: all 0.2s ease;
      display: flex; align-items: center; justify-content: center;
    }
    .ai-fab:hover { transform: scale(1.1); box-shadow: 0 6px 24px rgba(139, 92, 246, 0.5); }
    .ai-chat-panel {
      position: fixed; bottom: 88px; right: 24px; z-index: 200;
      width: 380px; max-height: 500px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); box-shadow: 0 16px 48px rgba(0,0,0,0.5);
      display: none; flex-direction: column; overflow: hidden;
    }
    .ai-chat-panel.open { display: flex; }
    .ai-chat-header {
      padding: 14px 16px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .ai-chat-title { font-size: 14px; font-weight: 700; color: var(--text-primary); }
    .ai-chat-title span { background: linear-gradient(135deg, #a78bfa, #60a5fa); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .ai-chat-close { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; }
    .ai-chat-body { flex: 1; overflow-y: auto; padding: 16px; }
    .ai-msg { margin-bottom: 12px; font-size: 13px; line-height: 1.6; }
    .ai-msg.assistant { color: var(--text-primary); background: rgba(139,92,246,0.06); padding: 10px 14px; border-radius: var(--radius-sm); border-left: 3px solid var(--purple); }
    .ai-msg.user { color: var(--text-secondary); text-align: right; }
    .ai-chat-input {
      display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--border);
    }
    .ai-chat-input input {
      flex: 1; background: var(--bg-input); border: 1px solid var(--border);
      color: var(--text-primary); padding: 8px 12px; border-radius: var(--radius-sm);
      font-size: 13px; outline: none;
    }
    .ai-chat-input input::placeholder { color: var(--text-muted); }
    .ai-chat-input button {
      background: var(--accent); color: #fff; border: none;
      padding: 8px 14px; border-radius: var(--radius-sm);
      font-size: 13px; font-weight: 600; cursor: pointer;
    }

    /* === Ranking badge === */
    .rank-badge {
      display: inline-flex; align-items: center; justify-content: center;
      width: 22px; height: 22px; border-radius: 50%;
      font-size: 11px; font-weight: 700;
    }
    .rank-1 { background: rgba(245,158,11,0.2); color: #f59e0b; }
    .rank-2 { background: rgba(148,163,184,0.2); color: #94a3b8; }
    .rank-3 { background: rgba(180,83,9,0.2); color: #d97706; }
    .rank-other { background: rgba(100,116,139,0.1); color: var(--text-muted); }

    /* === Member avatar === */
    .member-avatar {
      width: 48px; height: 48px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: 800; color: #fff;
    }
    .member-header-info { display: flex; align-items: center; gap: 16px; }
    .member-header-info h1 { margin: 0; }

    /* === Responsive === */
    @media (max-width: 1200px) {
      .sidebar { transform: translateX(-100%); }
      .main-content { margin-left: 0; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .classification-bar { flex-direction: column; }
    }
  </style>
</head>
<body>
<div class="page-layout">

  <!-- ==================== SIDEBAR ==================== -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <span class="sidebar-logo-mark">aida</span>
        <span class="sidebar-logo-text">Analytics</span>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="sidebar-section"><span class="persona-dot team"></span>Team</div>
      <a class="active" onclick="switchView('overview',this)">概要</a>
      <a onclick="switchView('tokens',this)">トークン分析</a>
      <a onclick="switchView('members',this)">メンバー分析</a>
      <div class="sidebar-section"><span class="persona-dot personal"></span>Personal</div>
      <a onclick="switchView('sessions',this)">セッション分析</a>
      <a onclick="switchView('repos',this)">リポジトリ分析</a>
      <a onclick="switchView('feed',this)">プロンプトフィード</a>
    </nav>
    <div class="sidebar-filters">
      <label>期間</label>
      <select><option>直近 30 日</option><option>直近 7 日</option><option>今月</option></select>
      <label>メンバー</label>
      <select><option value="">全員</option><option>t.hirai</option><option>k.tanaka</option><option>s.yamada</option></select>
      <label>リポジトリ</label>
      <select><option value="">すべて</option><option>claude-activity-tracker</option><option>web-app</option></select>
      <label>モデル</label>
      <select><option value="">すべて</option><option>Opus</option><option>Sonnet</option><option>Haiku</option></select>
      <div class="filter-saved-badge">
        <span class="filter-saved-dot"></span>
        フィルター保存済み
      </div>
    </div>
  </aside>

  <!-- ==================== MAIN ==================== -->
  <main class="main-content">

    <!-- ===== PAGE 1: 概要（マネージャー向け） ===== -->
    <div id="view-overview" class="view active">
      <div class="page-header">
        <h1>概要</h1>
        <p>チーム全体の活用状況を一目で把握 &mdash; 導入率・トークン消費・効率をモニタリング</p>
      </div>
      <div class="page-body">
        <div class="kpi-grid">
          <div class="kpi-card blue">
            <div class="kpi-label">合計トークン</div>
            <div class="kpi-value">5.6M</div>
            <div class="kpi-trend up-bad">&#9650; 12.5% vs 前週</div>
            <div class="kpi-sub">142 セッション</div>
          </div>
          <div class="kpi-card green">
            <div class="kpi-label">アクティブ率</div>
            <div class="kpi-value">4 / 5</div>
            <div class="kpi-trend up-good">&#9650; 1 名増加</div>
            <div class="kpi-sub">チームの 80%</div>
          </div>
          <div class="kpi-card purple">
            <div class="kpi-label">平均ターン数 / セッション</div>
            <div class="kpi-value">12.4</div>
            <div class="kpi-trend down-good">&#9660; 8.3% vs 前週</div>
            <div class="kpi-sub">効率改善傾向</div>
          </div>
          <div class="kpi-card amber">
            <div class="kpi-label">キャッシュ効率</div>
            <div class="kpi-value">68.2%</div>
            <div class="kpi-trend up-good">&#9650; 3.1% vs 前週</div>
            <div class="kpi-sub">cache_read / total_input</div>
          </div>
        </div>

        <div class="hint-card">
          <div class="hint-icon">i</div>
          <div class="hint-body">
            <div class="hint-title">ヒント</div>
            <div class="hint-text">今週のターン数/セッションが 8.3% 減少しました。チーム全体でプロンプト設計が改善しています。</div>
          </div>
        </div>
        <div class="hint-card warning">
          <div class="hint-icon">!</div>
          <div class="hint-body">
            <div class="hint-title">トークン消費アラート</div>
            <div class="hint-text">合計トークンが前週比 12.5% 増加しています。Opus の利用が全体の 78% を占めています。</div>
            <div class="hint-link" onclick="switchView('tokens')">トークン分析を見る &rarr;</div>
          </div>
        </div>

        <div class="grid-1">
          <div class="card">
            <div class="card-header"><div class="card-title">日別トークン推移</div></div>
            <div class="card-body"><div class="chart-container" style="height:280px"><canvas id="chart-daily-tokens"></canvas></div></div>
          </div>
        </div>
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><div class="card-title">ツール使用 Top 10</div></div>
            <div class="card-body"><div class="chart-container" style="height:280px"><canvas id="chart-tools"></canvas></div></div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">時間帯ヒートマップ</div></div>
            <div class="card-body">
              <table class="heatmap-table">
                <thead><tr><th></th><th>0</th><th>3</th><th>6</th><th>9</th><th>12</th><th>15</th><th>18</th><th>21</th></tr></thead>
                <tbody id="heatmap-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- セキュリティアラート -->
        <div class="hint-card warning" style="margin-bottom:20px">
          <div class="hint-icon">!</div>
          <div class="hint-body">
            <div class="hint-title">セキュリティアラート</div>
            <div class="hint-text">bypass: 0 件 / 異常終了: 2 件 / エラー率: 4.2%</div>
          </div>
        </div>

        <!-- メンバー別トークン Top5 + 生産性レーダー -->
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><div class="card-title">メンバー別トークン Top 5</div></div>
            <div class="card-body"><div class="chart-container" style="height:240px"><canvas id="chart-member-tokens-top5"></canvas></div></div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">生産性レーダー</div></div>
            <div class="card-body"><div class="chart-container" style="height:240px"><canvas id="chart-radar"></canvas></div></div>
          </div>
        </div>

        <!-- 最近のセッション -->
        <div class="card">
          <div class="card-header"><div class="card-title">最近のセッション</div></div>
          <div class="card-body" style="padding:0">
            <table class="data-table">
              <thead><tr><th>日時</th><th>メンバー</th><th>モデル</th><th>ターン</th><th class="text-right">トークン</th><th>リポジトリ</th></tr></thead>
              <tbody>
                <tr><td class="font-mono text-muted">02/14 16:42</td><td>t.hirai</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">3</td><td class="text-right font-mono">12.4K</td><td class="font-mono text-muted">claude-tracker</td></tr>
                <tr><td class="font-mono text-muted">02/14 14:18</td><td>k.tanaka</td><td><span class="badge badge-sonnet">Sonnet</span></td><td class="font-mono">12</td><td class="text-right font-mono">97.3K</td><td class="font-mono text-muted">web-app</td></tr>
                <tr><td class="font-mono text-muted">02/14 11:03</td><td>s.yamada</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">28</td><td class="text-right font-mono">284.0K</td><td class="font-mono text-muted">web-app</td></tr>
                <tr><td class="font-mono text-muted">02/14 09:30</td><td>t.hirai</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">42</td><td class="text-right font-mono">596.8K</td><td class="font-mono text-muted">claude-tracker</td></tr>
                <tr><td class="font-mono text-muted">02/13 17:55</td><td>k.tanaka</td><td><span class="badge badge-haiku">Haiku</span></td><td class="font-mono">5</td><td class="text-right font-mono">8.2K</td><td class="font-mono text-muted">docs-site</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PAGE 2: トークン分析（マネージャー向け） ===== -->
    <div id="view-tokens" class="view">
      <div class="page-header">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><h1>トークン分析</h1><p>モデル別トークン消費の追跡と最適化戦略</p></div>
          <button class="btn btn-ghost">CSV エクスポート</button>
        </div>
      </div>
      <div class="page-body">
        <div class="kpi-grid">
          <div class="kpi-card blue"><div class="kpi-label">合計トークン</div><div class="kpi-value">5.6M</div><div class="kpi-trend up-bad">&#9650; 12.5% vs 前週</div></div>
          <div class="kpi-card green"><div class="kpi-label">月末予測</div><div class="kpi-value">7.2M</div><div class="kpi-trend neutral">線形推計</div></div>
          <div class="kpi-card purple"><div class="kpi-label">サブエージェント比率</div><div class="kpi-value">23.4%</div><div class="kpi-trend up-bad">&#9650; 5.2%</div></div>
          <div class="kpi-card amber"><div class="kpi-label">トークン / セッション</div><div class="kpi-value">39.4K</div><div class="kpi-trend down-good">&#9660; 4.1%</div></div>
        </div>
        <div class="hint-card">
          <div class="hint-icon">i</div>
          <div class="hint-body">
            <div class="hint-title">モデル戦略</div>
            <div class="hint-text">Opus が全トークンの 78% を消費しています。定型作業（ファイル読み取り、検索）を Sonnet に切り替えることでトークン消費を最適化できます。</div>
          </div>
        </div>
        <div class="grid-1">
          <div class="card">
            <div class="card-header"><div class="card-title">日別トークン推移 + 予測</div></div>
            <div class="card-body"><div class="chart-container" style="height:300px"><canvas id="chart-token-daily"></canvas></div></div>
          </div>
        </div>
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><div class="card-title">モデル別トークン内訳</div></div>
            <div class="card-body"><div class="chart-container" style="height:240px"><canvas id="chart-token-model"></canvas></div></div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">モデル比率シミュレーション</div></div>
            <div class="card-body">
              <table class="data-table">
                <thead><tr><th>シナリオ</th><th class="text-right">月間トークン</th><th class="text-right">Opus 比率</th></tr></thead>
                <tbody>
                  <tr><td>現在 (Opus 78%)</td><td class="text-right font-mono">7.2M</td><td class="text-right text-muted">78%</td></tr>
                  <tr><td>Opus 50% / Sonnet 50%</td><td class="text-right font-mono">7.2M</td><td class="text-right">50%</td></tr>
                  <tr><td>Opus 30% / Sonnet 70%</td><td class="text-right font-mono">7.2M</td><td class="text-right">30%</td></tr>
                  <tr><td>全 Sonnet</td><td class="text-right font-mono">7.2M</td><td class="text-right">0%</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- トークン種別内訳 + メンバー別トークン -->
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><div class="card-title">トークン種別内訳</div></div>
            <div class="card-body"><div class="chart-container" style="height:240px"><canvas id="chart-token-type"></canvas></div></div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">メンバー別トークン</div></div>
            <div class="card-body"><div class="chart-container" style="height:240px"><canvas id="chart-token-by-member"></canvas></div></div>
          </div>
        </div>

        <!-- メンバー別トークン消費テーブル -->
        <div class="card">
          <div class="card-header"><div class="card-title">メンバー別トークン消費</div></div>
          <div class="card-body" style="padding:0">
            <table class="data-table">
              <thead><tr><th>メンバー</th><th class="text-right">Input</th><th class="text-right">Output</th><th class="text-right">Cache Read</th><th class="text-right">Cache Write</th><th class="text-right">合計</th><th class="text-right">サブエージェント</th></tr></thead>
              <tbody>
                <tr><td><strong>t.hirai</strong></td><td class="text-right font-mono">620K</td><td class="text-right font-mono">380K</td><td class="text-right font-mono">890K</td><td class="text-right font-mono">210K</td><td class="text-right font-mono">2.1M</td><td class="text-right font-mono">492K</td></tr>
                <tr><td><strong>k.tanaka</strong></td><td class="text-right font-mono">380K</td><td class="text-right font-mono">220K</td><td class="text-right font-mono">480K</td><td class="text-right font-mono">120K</td><td class="text-right font-mono">1.2M</td><td class="text-right font-mono">185K</td></tr>
                <tr><td><strong>s.yamada</strong></td><td class="text-right font-mono">450K</td><td class="text-right font-mono">280K</td><td class="text-right font-mono">580K</td><td class="text-right font-mono">190K</td><td class="text-right font-mono">1.5M</td><td class="text-right font-mono">348K</td></tr>
                <tr><td><strong>a.suzuki</strong></td><td class="text-right font-mono">240K</td><td class="text-right font-mono">160K</td><td class="text-right font-mono">320K</td><td class="text-right font-mono">80K</td><td class="text-right font-mono">0.8M</td><td class="text-right font-mono">112K</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PAGE 3: メンバー分析（マネージャー向け・一覧） ===== -->
    <div id="view-members" class="view">
      <div class="page-header">
        <h1>メンバー分析</h1>
        <p>チームのパフォーマンスを比較し、コーチング機会を特定する</p>
      </div>
      <div class="page-body">
        <div class="kpi-grid">
          <div class="kpi-card green"><div class="kpi-label">アクティブ率</div><div class="kpi-value">4 / 5</div><div class="kpi-sub">チームの 80%</div></div>
          <div class="kpi-card blue"><div class="kpi-label">最高効率</div><div class="kpi-value" style="font-size:20px">k.tanaka</div><div class="kpi-sub">8.2 ターン/セッション</div></div>
          <div class="kpi-card purple"><div class="kpi-label">最多トークン</div><div class="kpi-value" style="font-size:20px">t.hirai</div><div class="kpi-sub">2.1M (37.5%)</div></div>
          <div class="kpi-card amber"><div class="kpi-label">チーム平均トークン/日</div><div class="kpi-value">186.7K</div><div class="kpi-trend up-bad">&#9650; 8.1%</div></div>
        </div>
        <div class="hint-card warning">
          <div class="hint-icon">!</div>
          <div class="hint-body">
            <div class="hint-title">コーチング機会</div>
            <div class="hint-text">a.suzuki のセッション数が 22% 減少し、平均ターン数 (18.7) はチーム最多です。プロンプト構造化やタスク分解の 1:1 を検討してください。</div>
          </div>
        </div>
        <div class="hint-card">
          <div class="hint-icon">i</div>
          <div class="hint-body">
            <div class="hint-title">ベストプラクティス</div>
            <div class="hint-text">k.tanaka は最少ターン数 (8.2) で高いアウトプットを実現しています。CLAUDE.md の設定やプロンプトパターンの共有がチーム改善に繋がります。</div>
          </div>
        </div>
        <!-- メンバー×日付 トークンヒートマップ -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header"><div class="card-title">メンバー別トークンヒートマップ</div><div style="font-size:11px;color:var(--text-muted)">色の濃さ = トークン消費量</div></div>
          <div class="card-body">
            <table class="heatmap-table" id="member-token-heatmap">
              <thead id="member-heatmap-header"></thead>
              <tbody id="member-heatmap-body"></tbody>
            </table>
          </div>
        </div>

        <!-- メンバー×日付 ターン/セッションヒートマップ -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header"><div class="card-title">メンバー別ターン/セッションヒートマップ</div><div style="font-size:11px;color:var(--text-muted)">ターン数 (セッション数)</div></div>
          <div class="card-body">
            <table class="heatmap-table" id="member-turn-heatmap">
              <thead id="member-turn-header"></thead>
              <tbody id="member-turn-body"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">メンバー一覧</div><div style="font-size:12px;color:var(--text-muted)">クリックで詳細へ</div></div>
          <div class="card-body" style="padding:0">
            <table class="data-table">
              <thead>
                <tr><th>順位</th><th>メンバー</th><th class="text-right">セッション</th><th class="text-right">推移</th><th class="text-right">平均ターン</th><th class="text-right">トークン</th><th class="text-right">推移</th><th class="text-right">トークン/セッション</th></tr>
              </thead>
              <tbody>
                <tr style="cursor:pointer" onclick="switchView('member-detail',this)"><td><span class="rank-badge rank-1">1</span></td><td><strong>k.tanaka</strong></td><td class="text-right font-mono">42</td><td class="text-right"><span class="trend-up">&#9650; 12%</span></td><td class="text-right font-mono">8.2</td><td class="text-right font-mono">1.2M</td><td class="text-right"><span class="trend-down">&#9660; 3%</span></td><td class="text-right font-mono">28.6K</td></tr>
                <tr style="cursor:pointer" onclick="switchView('member-detail',this)"><td><span class="rank-badge rank-2">2</span></td><td><strong>t.hirai</strong></td><td class="text-right font-mono">48</td><td class="text-right"><span class="trend-up">&#9650; 5%</span></td><td class="text-right font-mono">14.1</td><td class="text-right font-mono">2.1M</td><td class="text-right"><span class="trend-up" style="color:var(--danger)">&#9650; 18%</span></td><td class="text-right font-mono">43.8K</td></tr>
                <tr style="cursor:pointer" onclick="switchView('member-detail',this)"><td><span class="rank-badge rank-3">3</span></td><td><strong>s.yamada</strong></td><td class="text-right font-mono">35</td><td class="text-right"><span class="trend-flat">&mdash;</span></td><td class="text-right font-mono">11.5</td><td class="text-right font-mono">1.5M</td><td class="text-right"><span class="trend-down">&#9660; 6%</span></td><td class="text-right font-mono">42.9K</td></tr>
                <tr style="cursor:pointer" onclick="switchView('member-detail',this)"><td><span class="rank-badge rank-other">4</span></td><td><strong>a.suzuki</strong></td><td class="text-right font-mono">17</td><td class="text-right"><span class="trend-down">&#9660; 22%</span></td><td class="text-right font-mono">18.7</td><td class="text-right font-mono">0.8M</td><td class="text-right"><span class="trend-down">&#9660; 15%</span></td><td class="text-right font-mono">47.1K</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PAGE 3b: メンバー詳細（ドリルダウン） ===== -->
    <div id="view-member-detail" class="view">
      <div class="page-header">
        <div class="breadcrumb">
          <a onclick="switchView('members')">メンバー分析</a>
          <span class="sep">/</span>
          <span>t.hirai</span>
        </div>
        <div class="member-header-info">
          <div class="member-avatar">TH</div>
          <div>
            <h1>t.hirai</h1>
            <p style="margin:0">直近 30 日間で 48 セッション &mdash; 効率ランク #2</p>
          </div>
        </div>
      </div>
      <div class="page-body">

        <!-- メンバー KPI -->
        <div class="kpi-grid">
          <div class="kpi-card blue"><div class="kpi-label">セッション数</div><div class="kpi-value">48</div><div class="kpi-trend up-good">&#9650; 5% vs 前週</div></div>
          <div class="kpi-card green"><div class="kpi-label">平均ターン数</div><div class="kpi-value">14.1</div><div class="kpi-trend down-good">&#9660; 11%</div><div class="kpi-sub">チーム平均: 12.4</div></div>
          <div class="kpi-card purple"><div class="kpi-label">合計トークン</div><div class="kpi-value">2.1M</div><div class="kpi-trend up-bad">&#9650; 18%</div><div class="kpi-sub">チームの 37.5%</div></div>
          <div class="kpi-card amber"><div class="kpi-label">効率スコア</div><div class="kpi-value">72</div><div class="kpi-trend up-good">&#9650; 5 pts</div></div>
        </div>

        <!-- AI 週次分析パネル -->
        <div class="ai-insight">
          <div class="ai-insight-header">
            <span class="ai-insight-label">AI 週次分析</span>
            <span class="ai-insight-badge">Agent SDK</span>
          </div>
          <div class="ai-insight-body">
            <p><strong>t.hirai の 4 週間 KPI 推移:</strong></p>
            <ul>
              <li><strong>第 1 週 (1/20-26):</strong> 10 セッション, 平均 18.3 ターン, 482K トークン &mdash; 探索フェーズ。claude-tracker で「ヘビー」セッション多数。</li>
              <li><strong>第 2 週 (1/27-2/2):</strong> 12 セッション, 平均 16.1 ターン, 580K トークン &mdash; トークン消費ピーク。4 回の Opus ヘビーセッションが大部分を占めた。</li>
              <li><strong>第 3 週 (2/3-9):</strong> 14 セッション, 平均 13.2 ターン, 620K トークン &mdash; ターン数が減少傾向。「Focused Build」セッションが増加。</li>
              <li><strong>第 4 週 (2/10-14):</strong> 12 セッション, 平均 11.8 ターン, 418K トークン &mdash; 最高効率。CLAUDE.md の更新がやり取り削減に貢献。</li>
            </ul>
            <p><strong>アドバイス:</strong> ターン数/セッションが 4 週間で 35% 改善（18.3 → 11.8）。第 3 週の CLAUDE.md 改善が最大の効果をもたらしました。プロジェクトパターンをさらに詳細に文書化することで、追加の改善が見込めます。claude-tracker のヘビーセッションには Task ツールの並列サブタスクが有効です。</p>
          </div>
          <div class="ai-insight-actions">
            <button>分析を再生成</button>
            <button>チームと比較</button>
            <button>レポート出力</button>
          </div>
        </div>

        <!-- 週次 KPI トレンドチャート -->
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><div class="card-title">週次 KPI トレンド</div></div>
            <div class="card-body"><div class="chart-container" style="height:260px"><canvas id="chart-member-weekly"></canvas></div></div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">モデル使用状況</div></div>
            <div class="card-body"><div class="chart-container" style="height:260px"><canvas id="chart-member-model"></canvas></div></div>
          </div>
        </div>

        <!-- セッション分類 -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header"><div class="card-title">セッション種別分布</div></div>
          <div class="card-body">
            <div class="classification-bar">
              <div class="class-item"><div class="class-dot" style="background:#22c55e"></div><div class="class-info"><div class="class-name">Quick Fix</div><div class="class-pct">35%</div></div></div>
              <div class="class-item"><div class="class-dot" style="background:#06b6d4"></div><div class="class-info"><div class="class-name">Focused Build</div><div class="class-pct">33%</div></div></div>
              <div class="class-item"><div class="class-dot" style="background:#f59e0b"></div><div class="class-info"><div class="class-name">Exploration</div><div class="class-pct">19%</div></div></div>
              <div class="class-item"><div class="class-dot" style="background:#ef4444"></div><div class="class-info"><div class="class-name">Heavy Session</div><div class="class-pct">13%</div></div></div>
            </div>
          </div>
        </div>

        <!-- ツール使用パターン -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header"><div class="card-title">ツール使用パターン</div></div>
          <div class="card-body"><div class="chart-container" style="height:200px"><canvas id="chart-member-tools"></canvas></div></div>
        </div>

        <!-- 最近のセッション -->
        <div class="card">
          <div class="card-header"><div class="card-title">最近のセッション</div></div>
          <div class="card-body" style="padding:0">
            <table class="data-table">
              <thead><tr><th>日時</th><th>モデル</th><th>ターン</th><th class="text-right">トークン<br><span style="font-weight:400;font-size:9px;color:var(--text-muted)">Turn / Sub / Total</span></th><th class="text-right">所要時間<br><span style="font-weight:400;font-size:9px;color:var(--text-muted)">レスポンス合計</span></th><th>リポジトリ</th><th>種別</th></tr></thead>
              <tbody>
                <tr><td class="font-mono text-muted">02/14 16:42</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">3</td><td class="text-right font-mono" style="white-space:nowrap">12.4K <span class="text-muted">/</span> 0 <span class="text-muted">/</span> 12.4K</td><td class="text-right font-mono">1m 48s</td><td class="font-mono text-muted">claude-tracker</td><td><span class="badge badge-success">Quick Fix</span></td></tr>
                <tr><td class="font-mono text-muted">02/14 09:30</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">42</td><td class="text-right font-mono" style="white-space:nowrap">512.3K <span class="text-muted">/</span> 84.5K <span class="text-muted">/</span> 596.8K</td><td class="text-right font-mono">28m 14s</td><td class="font-mono text-muted">claude-tracker</td><td><span class="badge badge-danger">Heavy</span></td></tr>
                <tr><td class="font-mono text-muted">02/13 14:15</td><td><span class="badge badge-sonnet">Sonnet</span></td><td class="font-mono">8</td><td class="text-right font-mono" style="white-space:nowrap">42.1K <span class="text-muted">/</span> 5.8K <span class="text-muted">/</span> 47.9K</td><td class="text-right font-mono">4m 18s</td><td class="font-mono text-muted">web-app</td><td><span class="badge badge-info">Focused</span></td></tr>
                <tr><td class="font-mono text-muted">02/12 16:50</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">22</td><td class="text-right font-mono" style="white-space:nowrap">198.4K <span class="text-muted">/</span> 28.6K <span class="text-muted">/</span> 227.0K</td><td class="text-right font-mono">14m 22s</td><td class="font-mono text-muted">claude-tracker</td><td><span class="badge badge-warning">Exploration</span></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PAGE 4: リポジトリ分析（メンバー向け・一覧） ===== -->
    <div id="view-repos" class="view">
      <div class="page-header"><h1>リポジトリ分析</h1><p>リポジトリごとの活動を追跡し、時間の使い方を把握する</p></div>
      <div class="page-body">
        <div class="kpi-grid">
          <div class="kpi-card blue"><div class="kpi-label">マイリポジトリ</div><div class="kpi-value">3</div><div class="kpi-sub">チーム全体: 5 リポ</div></div>
          <div class="kpi-card green"><div class="kpi-label">マイセッション</div><div class="kpi-value">48</div><div class="kpi-trend up-good">&#9650; 5%</div></div>
          <div class="kpi-card purple"><div class="kpi-label">マイトークン</div><div class="kpi-value">2.1M</div><div class="kpi-sub">チームの 37.5%</div></div>
          <div class="kpi-card amber"><div class="kpi-label">サブエージェント比率</div><div class="kpi-value">23.4%</div><div class="kpi-trend up-bad">&#9650; 5.2%</div></div>
        </div>
        <div class="hint-card">
          <div class="hint-icon">i</div>
          <div class="hint-body">
            <div class="hint-title">フォーカスインサイト</div>
            <div class="hint-text">セッションの 72% が claude-tracker に集中しています。このリポでは web-app の 3 倍のトークンを消費しています。一部の作業で Opus から Sonnet への切り替えを検討してみてください。</div>
          </div>
        </div>
        <!-- リポジトリ×日付 アクティビティヒートマップ -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header"><div class="card-title">リポジトリ別アクティビティヒートマップ</div><div style="font-size:11px;color:var(--text-muted)">色の濃さ = セッション数</div></div>
          <div class="card-body">
            <table class="heatmap-table" id="repo-heatmap">
              <thead id="repo-heatmap-header"></thead>
              <tbody id="repo-heatmap-body"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">リポジトリ一覧</div><div style="font-size:12px;color:var(--text-muted)">クリックで詳細へ</div></div>
          <div class="card-body" style="padding:0">
            <table class="data-table">
              <thead><tr><th>リポジトリ</th><th class="text-right">セッション</th><th class="text-right">推移</th><th class="text-right">コントリビューター</th><th class="text-right">トークン</th><th class="text-right">トークン/セッション</th></tr></thead>
              <tbody>
                <tr style="cursor:pointer" onclick="switchView('repo-detail',this)"><td><strong>claude-activity-tracker</strong></td><td class="text-right font-mono">62</td><td class="text-right"><span class="trend-up">&#9650; 15%</span></td><td class="text-right font-mono">3</td><td class="text-right font-mono">2.8M</td><td class="text-right font-mono">45.2K</td></tr>
                <tr style="cursor:pointer" onclick="switchView('repo-detail',this)"><td><strong>web-app</strong></td><td class="text-right font-mono">45</td><td class="text-right"><span class="trend-flat">&mdash;</span></td><td class="text-right font-mono">4</td><td class="text-right font-mono">1.8M</td><td class="text-right font-mono">40.0K</td></tr>
                <tr style="cursor:pointer" onclick="switchView('repo-detail',this)"><td><strong>api-server</strong></td><td class="text-right font-mono">20</td><td class="text-right"><span class="trend-down">&#9660; 10%</span></td><td class="text-right font-mono">2</td><td class="text-right font-mono">0.6M</td><td class="text-right font-mono">30.0K</td></tr>
                <tr style="cursor:pointer" onclick="switchView('repo-detail',this)"><td><strong>docs-site</strong></td><td class="text-right font-mono">10</td><td class="text-right"><span class="trend-up">&#9650; 40%</span></td><td class="text-right font-mono">2</td><td class="text-right font-mono">0.3M</td><td class="text-right font-mono">30.0K</td></tr>
                <tr style="cursor:pointer" onclick="switchView('repo-detail',this)"><td><strong>infra-scripts</strong></td><td class="text-right font-mono">5</td><td class="text-right"><span class="trend-flat">&mdash;</span></td><td class="text-right font-mono">1</td><td class="text-right font-mono">0.1M</td><td class="text-right font-mono">20.0K</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PAGE 4b: リポジトリ詳細（ドリルダウン） ===== -->
    <div id="view-repo-detail" class="view">
      <div class="page-header">
        <div class="breadcrumb">
          <a onclick="switchView('repos')">リポジトリ分析</a>
          <span class="sep">/</span>
          <span>claude-activity-tracker</span>
        </div>
        <h1>claude-activity-tracker</h1>
        <p>直近 30 日間で 3 名のコントリビューターから 62 セッション</p>
      </div>
      <div class="page-body">

        <!-- リポジトリ KPI -->
        <div class="kpi-grid">
          <div class="kpi-card blue"><div class="kpi-label">セッション数</div><div class="kpi-value">62</div><div class="kpi-trend up-good">&#9650; 15%</div></div>
          <div class="kpi-card green"><div class="kpi-label">コントリビューター</div><div class="kpi-value">3</div><div class="kpi-sub">t.hirai, k.tanaka, s.yamada</div></div>
          <div class="kpi-card purple"><div class="kpi-label">合計トークン</div><div class="kpi-value">2.8M</div><div class="kpi-trend up-bad">&#9650; 22%</div></div>
          <div class="kpi-card amber"><div class="kpi-label">ブランチ数</div><div class="kpi-value">8</div><div class="kpi-sub">期間中アクティブ</div></div>
        </div>

        <!-- AI リポジトリ分析パネル -->
        <div class="ai-insight">
          <div class="ai-insight-header">
            <span class="ai-insight-label">AI リポジトリ分析</span>
            <span class="ai-insight-badge">Agent SDK</span>
          </div>
          <div class="ai-insight-body">
            <p><strong>リポジトリ利用パターン:</strong></p>
            <ul>
              <li><strong>トークン集中:</strong> t.hirai がこのリポの 58%（1.6M）のトークンを消費。feature ブランチでの Opus ヘビーセッションが大部分を占める。</li>
              <li><strong>効率ギャップ:</strong> k.tanaka は同等のファイル変更量を 40% 少ないターン数で達成しており、プロンプト戦略の違いが示唆される。</li>
              <li><strong>ブランチ活動:</strong> <code>feature/dashboard-v2</code> が最多セッション数（18 回）。タスク分解の恩恵を受ける可能性がある。</li>
              <li><strong>ツールパターン:</strong> Read/Edit 比率が高い（3.2:1）ため、コード探索が多い。CLAUDE.md でコンテキストを事前読み込みすることで Read コールを削減できる。</li>
            </ul>
            <p><strong>アドバイス:</strong> リポ固有の CLAUDE.md にアーキテクチャノートとファイルインデックスを追加しましょう。探索ターンが推定 20-30% 削減できます。</p>
          </div>
          <div class="ai-insight-actions">
            <button>分析を再生成</button>
            <button>他リポと比較</button>
            <button>ブランチ内訳を見る</button>
          </div>
        </div>

        <!-- チャート -->
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><div class="card-title">日別アクティビティ</div></div>
            <div class="card-body"><div class="chart-container" style="height:240px"><canvas id="chart-repo-daily"></canvas></div></div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">コントリビューター内訳</div></div>
            <div class="card-body"><div class="chart-container" style="height:240px"><canvas id="chart-repo-contributors"></canvas></div></div>
          </div>
        </div>

        <!-- 変更頻度の高いファイル -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header"><div class="card-title">変更頻度の高いファイル</div></div>
          <div class="card-body" style="padding:0">
            <table class="data-table">
              <thead><tr><th>ファイルパス</th><th class="text-right">変更回数</th><th class="text-right">セッション数</th><th>主な操作</th></tr></thead>
              <tbody>
                <tr><td class="font-mono">server/public/js/dashboard.js</td><td class="text-right font-mono">42</td><td class="text-right font-mono">18</td><td><span class="badge badge-warning">Edit</span></td></tr>
                <tr><td class="font-mono">server/views/dashboard.ejs</td><td class="text-right font-mono">28</td><td class="text-right font-mono">14</td><td><span class="badge badge-warning">Edit</span></td></tr>
                <tr><td class="font-mono">server/src/services/dashboardService.ts</td><td class="text-right font-mono">22</td><td class="text-right font-mono">10</td><td><span class="badge badge-warning">Edit</span></td></tr>
                <tr><td class="font-mono">docs/analytics-expansion-plan.md</td><td class="text-right font-mono">15</td><td class="text-right font-mono">5</td><td><span class="badge badge-success">Create</span></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 最近のセッション -->
        <div class="card">
          <div class="card-header"><div class="card-title">最近のセッション</div></div>
          <div class="card-body" style="padding:0">
            <table class="data-table">
              <thead><tr><th>日時</th><th>メンバー</th><th>モデル</th><th>ターン</th><th class="text-right">トークン<br><span style="font-weight:400;font-size:9px;color:var(--text-muted)">Turn / Sub / Total</span></th><th class="text-right">所要時間<br><span style="font-weight:400;font-size:9px;color:var(--text-muted)">レスポンス合計</span></th><th>ブランチ</th><th>種別</th></tr></thead>
              <tbody>
                <tr><td class="font-mono text-muted">02/14 16:42</td><td>t.hirai</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">3</td><td class="text-right font-mono" style="white-space:nowrap">12.4K <span class="text-muted">/</span> 0 <span class="text-muted">/</span> 12.4K</td><td class="text-right font-mono">1m 48s</td><td class="font-mono text-muted">main</td><td><span class="badge badge-success">Quick Fix</span></td></tr>
                <tr><td class="font-mono text-muted">02/14 09:30</td><td>t.hirai</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">42</td><td class="text-right font-mono" style="white-space:nowrap">512.3K <span class="text-muted">/</span> 84.5K <span class="text-muted">/</span> 596.8K</td><td class="text-right font-mono">28m 14s</td><td class="font-mono text-muted">feature/dashboard-v2</td><td><span class="badge badge-danger">Heavy</span></td></tr>
                <tr><td class="font-mono text-muted">02/13 15:10</td><td>k.tanaka</td><td><span class="badge badge-sonnet">Sonnet</span></td><td class="font-mono">6</td><td class="text-right font-mono" style="white-space:nowrap">32.8K <span class="text-muted">/</span> 4.2K <span class="text-muted">/</span> 37.0K</td><td class="text-right font-mono">3m 05s</td><td class="font-mono text-muted">fix/api-auth</td><td><span class="badge badge-info">Focused</span></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PAGE 5: セッション分析（メンバー向け） ===== -->
    <div id="view-sessions" class="view">
      <div class="page-header">
        <h1>セッション分析</h1>
        <p>自分のセッションを振り返り、効率改善のパターンを発見する</p>
      </div>
      <div class="page-body">
        <div class="kpi-grid">
          <div class="kpi-card blue"><div class="kpi-label">マイセッション</div><div class="kpi-value">48</div><div class="kpi-trend up-good">&#9650; 5% vs 前週</div><div class="kpi-sub">直近 30 日</div></div>
          <div class="kpi-card green"><div class="kpi-label">平均ターン数</div><div class="kpi-value">14.1</div><div class="kpi-trend down-good">&#9660; 11% vs 前週</div><div class="kpi-sub">チーム平均: 12.4</div></div>
          <div class="kpi-card purple"><div class="kpi-label">マイトークン</div><div class="kpi-value">2.1M</div><div class="kpi-trend up-bad">&#9650; 18% vs 前週</div><div class="kpi-sub">チーム全体の 37.5%</div></div>
          <div class="kpi-card amber"><div class="kpi-label">効率スコア</div><div class="kpi-value">72</div><div class="kpi-trend up-good">&#9650; 5 pts</div><div class="kpi-sub">トークン/ターン正規化</div></div>
        </div>
        <div class="hint-card">
          <div class="hint-icon">i</div>
          <div class="hint-body">
            <div class="hint-title">改善ヒント</div>
            <div class="hint-text">平均ターン数 (14.1) がチーム平均 (12.4) を上回っています。大きなタスクを小さなサブタスクに分割するか、CLAUDE.md にプロジェクトコンテキストを追加してやり取りを減らしましょう。</div>
          </div>
        </div>

        <div class="tab-bar">
          <button class="tab-btn active" onclick="switchTab('tab-list',this)">マイセッション</button>
          <button class="tab-btn" onclick="switchTab('tab-efficiency',this)">効率分析</button>
        </div>

        <div id="tab-list" class="tab-content active">
          <div class="card">
            <div class="card-body" style="padding:0">
              <table class="data-table">
                <thead><tr><th>日時</th><th>メンバー</th><th>モデル</th><th>ターン</th><th class="text-right">トークン<br><span style="font-weight:400;font-size:9px;color:var(--text-muted)">Turn / Sub / Total</span></th><th class="text-right">所要時間<br><span style="font-weight:400;font-size:9px;color:var(--text-muted)">レスポンス合計</span></th><th>リポジトリ</th><th>分類</th></tr></thead>
                <tbody>
                  <tr style="cursor:pointer"><td class="font-mono text-muted">02/14 16:42</td><td>t.hirai</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">3</td><td class="text-right font-mono" style="white-space:nowrap">12.4K <span class="text-muted">/</span> 0 <span class="text-muted">/</span> 12.4K</td><td class="text-right font-mono">1m 48s</td><td class="font-mono text-muted">claude-tracker</td><td><span class="badge badge-success">Quick Fix</span></td></tr>
                  <tr style="cursor:pointer"><td class="font-mono text-muted">02/14 14:18</td><td>k.tanaka</td><td><span class="badge badge-sonnet">Sonnet</span></td><td class="font-mono">12</td><td class="text-right font-mono" style="white-space:nowrap">85.2K <span class="text-muted">/</span> 12.1K <span class="text-muted">/</span> 97.3K</td><td class="text-right font-mono">6m 42s</td><td class="font-mono text-muted">web-app</td><td><span class="badge badge-info">Focused</span></td></tr>
                  <tr style="cursor:pointer"><td class="font-mono text-muted">02/14 11:03</td><td>s.yamada</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">28</td><td class="text-right font-mono" style="white-space:nowrap">245.8K <span class="text-muted">/</span> 38.2K <span class="text-muted">/</span> 284.0K</td><td class="text-right font-mono">18m 35s</td><td class="font-mono text-muted">web-app</td><td><span class="badge badge-warning">Exploration</span></td></tr>
                  <tr style="cursor:pointer"><td class="font-mono text-muted">02/14 09:30</td><td>t.hirai</td><td><span class="badge badge-opus">Opus</span></td><td class="font-mono">42</td><td class="text-right font-mono" style="white-space:nowrap">512.3K <span class="text-muted">/</span> 84.5K <span class="text-muted">/</span> 596.8K</td><td class="text-right font-mono">28m 14s</td><td class="font-mono text-muted">claude-tracker</td><td><span class="badge badge-danger">Heavy</span></td></tr>
                  <tr style="cursor:pointer"><td class="font-mono text-muted">02/13 17:55</td><td>k.tanaka</td><td><span class="badge badge-haiku">Haiku</span></td><td class="font-mono">5</td><td class="text-right font-mono" style="white-space:nowrap">8.2K <span class="text-muted">/</span> 0 <span class="text-muted">/</span> 8.2K</td><td class="text-right font-mono">0m 52s</td><td class="font-mono text-muted">docs-site</td><td><span class="badge badge-success">Quick Fix</span></td></tr>
                  <tr style="cursor:pointer"><td class="font-mono text-muted">02/13 15:20</td><td>a.suzuki</td><td><span class="badge badge-sonnet">Sonnet</span></td><td class="font-mono">8</td><td class="text-right font-mono" style="white-space:nowrap">42.1K <span class="text-muted">/</span> 5.8K <span class="text-muted">/</span> 47.9K</td><td class="text-right font-mono">4m 18s</td><td class="font-mono text-muted">api-server</td><td><span class="badge badge-info">Focused</span></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="tab-efficiency" class="tab-content">
          <div class="classification-bar">
            <div class="class-item"><div class="class-dot" style="background:#22c55e"></div><div class="class-info"><div class="class-name">Quick Fix</div><div class="class-pct">42%</div><div class="class-desc">1-5 ターン, &lt; 15K トークン</div></div></div>
            <div class="class-item"><div class="class-dot" style="background:#06b6d4"></div><div class="class-info"><div class="class-name">Focused Build</div><div class="class-pct">31%</div><div class="class-desc">5-15 ターン, 15K-100K</div></div></div>
            <div class="class-item"><div class="class-dot" style="background:#f59e0b"></div><div class="class-info"><div class="class-name">Exploration</div><div class="class-pct">18%</div><div class="class-desc">15-30 ターン, 100K-300K</div></div></div>
            <div class="class-item"><div class="class-dot" style="background:#ef4444"></div><div class="class-info"><div class="class-name">Heavy Session</div><div class="class-pct">9%</div><div class="class-desc">30+ ターン, 300K+</div></div></div>
          </div>
          <div class="card" style="margin-bottom:20px">
            <div class="card-header"><div class="card-title">散布図: ターン数 vs トークン消費</div></div>
            <div class="card-body"><div class="chart-container" style="height:350px"><canvas id="chart-scatter"></canvas></div></div>
          </div>
          <div class="hint-card">
            <div class="hint-icon">i</div>
            <div class="hint-body">
              <div class="hint-title">インサイト</div>
              <div class="hint-text">9% のセッションが「Heavy」ですが、全トークンの 38% を消費しています。これらを小さなタスクに分割すると効率が向上します。</div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">セッション種別ごとのツール使用</div></div>
            <div class="card-body"><div class="chart-container" style="height:240px"><canvas id="chart-tool-by-class"></canvas></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PAGE 6: プロンプトフィード（メンバー向け・学習） ===== -->
    <div id="view-feed" class="view">
      <div class="page-header"><h1>プロンプトフィード</h1><p>チームのプロンプトから学ぶ &mdash; 効果的なパターンや新しいテクニックを発見</p></div>
      <div class="page-body">
        <div class="hint-card">
          <div class="hint-icon">i</div>
          <div class="hint-body">
            <div class="hint-title">学習ヒント</div>
            <div class="hint-text">k.tanaka はチームで最少のターン数/セッションを達成しています。以下の最近のプロンプトを参考に、効果的なパターンを取り入れましょう。</div>
          </div>
        </div>
        <div class="card"><div class="card-body" style="text-align:center;padding:40px;color:var(--text-muted)">チーム活動のプロンプトフィード（学習コンテキスト付きで現行実装を拡張）</div></div>
      </div>
    </div>

  </main>
</div>

<!-- AI アナリスト フローティング -->
<button class="ai-fab" onclick="toggleChat()" title="AI アナリスト">AI</button>
<div class="ai-chat-panel" id="ai-chat">
  <div class="ai-chat-header">
    <div class="ai-chat-title"><span>AI アナリスト</span></div>
    <button class="ai-chat-close" onclick="toggleChat()">&times;</button>
  </div>
  <div class="ai-chat-body">
    <div class="ai-msg user">今週 Opus の利用率が高い理由は？</div>
    <div class="ai-msg assistant">
      Opus のトークン消費が前週比 12.5% 増加しました。主な要因:<br><br>
      <strong>1. ヘビーセッションの増加</strong> &mdash; t.hirai が 8 回の 30+ ターンセッションを Opus で実行し、全増加分の大部分を占めました。<br><br>
      <strong>2. サブエージェント利用の増加</strong> &mdash; サブエージェント比率が 18% から 23.4% に上昇しました。<br><br>
      定型作業を Sonnet に切り替えると Opus トークン消費を最適化できます。
    </div>
  </div>
  <div class="ai-chat-input">
    <input type="text" placeholder="データについて質問...">
    <button>送信</button>
  </div>
</div>

<script>
// === ナビゲーション ===
function switchView(name, el) {
  document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
  document.getElementById('view-' + name).classList.add('active');
  var mainPages = ['overview','tokens','members','sessions','repos','feed'];
  if (mainPages.indexOf(name) >= 0) {
    document.querySelectorAll('.sidebar-nav a').forEach(function(a) { a.classList.remove('active'); });
    if (el && el.tagName === 'A') el.classList.add('active');
  }
  if (name === 'tokens' && !window._tokensRendered) { renderTokenCharts(); window._tokensRendered = true; }
  if (name === 'member-detail' && !window._memberDetailRendered) { renderMemberDetailCharts(); window._memberDetailRendered = true; }
  if (name === 'repo-detail' && !window._repoDetailRendered) { renderRepoDetailCharts(); window._repoDetailRendered = true; }
  window.scrollTo(0, 0);
}

// === タブ ===
function switchTab(id, btn) {
  btn.closest('.page-body').querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
  btn.closest('.page-body').querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if (id === 'tab-efficiency' && !window._scatterRendered) { renderEfficiencyCharts(); window._scatterRendered = true; }
}

// === AI チャット ===
function toggleChat() {
  document.getElementById('ai-chat').classList.toggle('open');
}

// === チャートデフォルト ===
Chart.defaults.color = '#94a3b8';
Chart.defaults.borderColor = 'rgba(148,163,184,0.1)';

// === 概要チャート ===
(function renderOverview() {
  var dates = [], opus = [], sonnet = [], haiku = [];
  for (var i = 29; i >= 0; i--) {
    var d = new Date(); d.setDate(d.getDate() - i);
    dates.push(d.toISOString().slice(0,10));
    opus.push(Math.floor(Math.random()*80000+40000));
    sonnet.push(Math.floor(Math.random()*120000+60000));
    haiku.push(Math.floor(Math.random()*30000+10000));
  }
  new Chart(document.getElementById('chart-daily-tokens'), {
    type: 'bar',
    data: { labels: dates, datasets: [
      { label: 'Opus', data: opus, backgroundColor: '#8b5cf6', stack: 's' },
      { label: 'Sonnet', data: sonnet, backgroundColor: '#3b82f6', stack: 's' },
      { label: 'Haiku', data: haiku, backgroundColor: '#22d3ee', stack: 's' },
    ]},
    options: { responsive: true, maintainAspectRatio: false, scales: {
      x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MM/dd' } }, stacked: true, grid: { display: false } },
      y: { stacked: true, ticks: { callback: function(v) { return (v/1000)+'K'; } } }
    }, plugins: { legend: { position: 'top', labels: { boxWidth: 12 } } } }
  });

  new Chart(document.getElementById('chart-tools'), {
    type: 'bar',
    data: { labels: ['Read', 'Edit', 'Bash', 'Glob', 'Grep', 'Write', 'Task', 'WebFetch', 'NotebookEdit', 'Skill'],
      datasets: [{ data: [342, 289, 245, 198, 187, 124, 98, 67, 34, 21], backgroundColor: '#3b82f6', borderRadius: 4 }] },
    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      scales: { x: { grid: { display: false } }, y: { grid: { display: false } } },
      plugins: { legend: { display: false } } }
  });

  var days = ['月','火','水','木','金','土','日'];
  var body = document.getElementById('heatmap-body');
  days.forEach(function(day, idx) {
    var tr = document.createElement('tr');
    tr.innerHTML = '<td class="day-label">' + day + '</td>';
    for (var h = 0; h < 8; h++) {
      var val = (idx >= 5) ? Math.random()*0.2 : Math.random();
      var alpha = (val * 0.8 + 0.05).toFixed(2);
      tr.innerHTML += '<td class="cell" style="background:rgba(59,130,246,' + alpha + ')" title="' + Math.floor(val*20) + ' セッション"></td>';
    }
    body.appendChild(tr);
  });

  // メンバー別トークン Top5
  new Chart(document.getElementById('chart-member-tokens-top5'), {
    type: 'bar',
    data: { labels: ['t.hirai', 's.yamada', 'k.tanaka', 'a.suzuki', 'm.sato'],
      datasets: [{ data: [2100, 1500, 1200, 800, 0], backgroundColor: '#8b5cf6', borderRadius: 4, label: 'トークン (K)' }] },
    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      scales: { x: { grid: { display: false }, ticks: { callback: function(v) { return v + 'K'; } } }, y: { grid: { display: false } } },
      plugins: { legend: { display: false } } }
  });

  // 生産性レーダー
  new Chart(document.getElementById('chart-radar'), {
    type: 'radar',
    data: { labels: ['ターン効率', 'キャッシュ率', 'ツール活用', 'モデル最適', '活動頻度'],
      datasets: [
        { label: 't.hirai', data: [65, 72, 85, 45, 90], borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.15)', pointRadius: 3 },
        { label: 'k.tanaka', data: [92, 80, 75, 88, 78], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.15)', pointRadius: 3 },
      ]},
    options: { responsive: true, maintainAspectRatio: false,
      scales: { r: { beginAtZero: true, max: 100, ticks: { stepSize: 25, color: '#64748b' }, grid: { color: 'rgba(148,163,184,0.1)' }, pointLabels: { color: '#94a3b8', font: { size: 11 } } } },
      plugins: { legend: { position: 'top', labels: { boxWidth: 10 } } } }
  });

  // メンバー×日付 トークンヒートマップ
  (function renderMemberHeatmaps() {
    var members = ['t.hirai', 'k.tanaka', 's.yamada', 'a.suzuki'];
    var dates = [];
    for (var i = 13; i >= 0; i--) {
      var d = new Date(); d.setDate(d.getDate() - i);
      dates.push(d.toISOString().slice(5,10));
    }
    var headerRow = '<tr><th></th>';
    dates.forEach(function(d) { headerRow += '<th>' + d + '</th>'; });
    headerRow += '</tr>';
    document.getElementById('member-heatmap-header').innerHTML = headerRow;
    document.getElementById('member-turn-header').innerHTML = headerRow;
    var tokenBody = document.getElementById('member-heatmap-body');
    var turnBody = document.getElementById('member-turn-body');
    members.forEach(function(m) {
      var tr1 = '<tr><td class="day-label">' + m + '</td>';
      var tr2 = '<tr><td class="day-label">' + m + '</td>';
      dates.forEach(function() {
        var tokens = Math.floor(Math.random() * 200000);
        var alpha = Math.min(tokens / 200000, 1) * 0.8 + 0.05;
        tr1 += '<td class="cell" style="background:rgba(139,92,246,' + alpha.toFixed(2) + ')" title="' + (tokens/1000).toFixed(0) + 'K">' + (tokens > 50000 ? (tokens/1000).toFixed(0) + 'K' : '') + '</td>';
        var turns = Math.floor(Math.random() * 60);
        var sessions = Math.floor(Math.random() * 5);
        var a2 = Math.min(turns / 50, 1) * 0.8 + 0.05;
        tr2 += '<td class="cell" style="background:rgba(59,130,246,' + a2.toFixed(2) + ')" title="' + turns + ' ターン / ' + sessions + ' セッション">' + (turns > 0 ? turns + '<span style=font-size:9px;color:var(--text-muted)>(' + sessions + ')</span>' : '') + '</td>';
      });
      tr1 += '</tr>'; tr2 += '</tr>';
      tokenBody.innerHTML += tr1;
      turnBody.innerHTML += tr2;
    });
  })();

  // リポジトリ×日付 ヒートマップ
  (function renderRepoHeatmap() {
    var repos = ['claude-tracker', 'web-app', 'api-server', 'docs-site', 'infra-scripts'];
    var dates = [];
    for (var i = 13; i >= 0; i--) {
      var d = new Date(); d.setDate(d.getDate() - i);
      dates.push(d.toISOString().slice(5,10));
    }
    var headerRow = '<tr><th></th>';
    dates.forEach(function(d) { headerRow += '<th>' + d + '</th>'; });
    headerRow += '</tr>';
    document.getElementById('repo-heatmap-header').innerHTML = headerRow;
    var body = document.getElementById('repo-heatmap-body');
    repos.forEach(function(r) {
      var tr = '<tr><td class="day-label">' + r + '</td>';
      dates.forEach(function() {
        var val = Math.floor(Math.random() * 6);
        var alpha = val > 0 ? (val / 5 * 0.8 + 0.1) : 0.03;
        tr += '<td class="cell" style="background:rgba(34,197,94,' + alpha.toFixed(2) + ')" title="' + val + ' セッション">' + (val > 0 ? val : '') + '</td>';
      });
      tr += '</tr>';
      body.innerHTML += tr;
    });
  })();
})();

// === トークン分析チャート ===
function renderTokenCharts() {
  var dates = [], actual = [], forecast = [];
  for (var i = 29; i >= 0; i--) {
    var d = new Date(); d.setDate(d.getDate() - i);
    dates.push(d.toISOString().slice(0,10));
    actual.push(Math.floor(Math.random()*150000+80000)); forecast.push(null);
  }
  for (var i = 1; i <= 15; i++) {
    var d = new Date(); d.setDate(d.getDate() + i);
    dates.push(d.toISOString().slice(0,10));
    actual.push(null); forecast.push(Math.floor(180000 + Math.random()*40000));
  }
  var regression = actual.map(function(v, idx) { return v !== null ? null : forecast[idx]; });
  var lastActualIdx = actual.findIndex(function(v,i) { return v !== null && actual[i+1] === null; });
  if (lastActualIdx >= 0) regression[lastActualIdx] = actual[lastActualIdx];

  new Chart(document.getElementById('chart-token-daily'), {
    type: 'bar', data: { labels: dates, datasets: [
      { type: 'bar', label: '日別トークン', data: actual, backgroundColor: 'rgba(59,130,246,0.6)', borderRadius: 3, order: 2 },
      { type: 'line', label: '予測', data: regression, borderColor: '#f59e0b', borderDash: [6,4], borderWidth: 2, pointRadius: 0, spanGaps: true, order: 1 },
    ]}, options: { responsive: true, maintainAspectRatio: false, scales: {
      x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MM/dd' } }, grid: { display: false } },
      y: { ticks: { callback: function(v) { return (v/1000)+'K'; } } }
    }, plugins: { legend: { position: 'top', labels: { boxWidth: 12 } } } }
  });

  new Chart(document.getElementById('chart-token-model'), {
    type: 'doughnut', data: { labels: ['Opus', 'Sonnet', 'Haiku'],
      datasets: [{ data: [4368000, 1064000, 168000], backgroundColor: ['#8b5cf6','#3b82f6','#22d3ee'], borderWidth: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, cutout: '65%',
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 16 } },
        tooltip: { callbacks: { label: function(ctx) { return ctx.label + ': ' + (ctx.parsed/1000000).toFixed(1) + 'M'; } } }
      } }
  });

  // トークン種別内訳（Input / Output / Cache Read / Cache Write）
  new Chart(document.getElementById('chart-token-type'), {
    type: 'doughnut', data: { labels: ['Input', 'Output', 'Cache Read', 'Cache Write'],
      datasets: [{ data: [1690000, 1040000, 2270000, 600000], backgroundColor: ['#3b82f6','#8b5cf6','#22c55e','#f59e0b'], borderWidth: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, cutout: '65%',
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 16 } },
        tooltip: { callbacks: { label: function(ctx) { return ctx.label + ': ' + (ctx.parsed/1000000).toFixed(1) + 'M'; } } }
      } }
  });

  // メンバー別トークン
  new Chart(document.getElementById('chart-token-by-member'), {
    type: 'bar',
    data: { labels: ['t.hirai', 's.yamada', 'k.tanaka', 'a.suzuki'],
      datasets: [
        { label: 'Opus', data: [1470, 900, 480, 560], backgroundColor: '#8b5cf6', stack: 's' },
        { label: 'Sonnet', data: [420, 480, 600, 200], backgroundColor: '#3b82f6', stack: 's' },
        { label: 'Haiku', data: [210, 120, 120, 40], backgroundColor: '#22d3ee', stack: 's' },
      ]},
    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      scales: { x: { stacked: true, grid: { display: false }, ticks: { callback: function(v) { return v+'K'; } } }, y: { stacked: true, grid: { display: false } } },
      plugins: { legend: { position: 'top', labels: { boxWidth: 10 } } } }
  });
}

// === メンバー詳細チャート ===
function renderMemberDetailCharts() {
  new Chart(document.getElementById('chart-member-weekly'), {
    type: 'bar', data: { labels: ['第1週 (1/20)', '第2週 (1/27)', '第3週 (2/3)', '第4週 (2/10)'],
      datasets: [
        { type: 'bar', label: 'セッション数', data: [10, 12, 14, 12], backgroundColor: 'rgba(59,130,246,0.5)', borderRadius: 4, yAxisID: 'y' },
        { type: 'line', label: '平均ターン', data: [18.3, 16.1, 13.2, 11.8], borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.3, pointRadius: 5, yAxisID: 'y1' },
        { type: 'line', label: 'トークン (K)', data: [482, 580, 620, 418], borderColor: '#f59e0b', borderDash: [4,3], tension: 0.3, pointRadius: 5, yAxisID: 'y2' },
      ]},
    options: { responsive: true, maintainAspectRatio: false, scales: {
      y: { position: 'left', title: { display: true, text: 'セッション', color: '#64748b' }, grid: { display: false } },
      y1: { position: 'right', title: { display: true, text: '平均ターン', color: '#22c55e' }, grid: { display: false } },
      y2: { display: false },
    }, plugins: { legend: { position: 'top', labels: { boxWidth: 10 } } } }
  });

  new Chart(document.getElementById('chart-member-model'), {
    type: 'doughnut', data: { labels: ['Opus', 'Sonnet', 'Haiku'],
      datasets: [{ data: [30, 14, 4], backgroundColor: ['#8b5cf6','#3b82f6','#22d3ee'], borderWidth: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, cutout: '65%',
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 16 } } } }
  });

  new Chart(document.getElementById('chart-member-tools'), {
    type: 'bar', data: { labels: ['Read', 'Edit', 'Bash', 'Glob', 'Grep', 'Write', 'Task'],
      datasets: [{ data: [156, 132, 98, 78, 72, 45, 28], backgroundColor: '#3b82f6', borderRadius: 4 }] },
    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      scales: { x: { grid: { display: false } }, y: { grid: { display: false } } },
      plugins: { legend: { display: false } } }
  });
}

// === リポジトリ詳細チャート ===
function renderRepoDetailCharts() {
  var dates = [];
  var sessions = [];
  for (var i = 29; i >= 0; i--) {
    var d = new Date(); d.setDate(d.getDate() - i);
    dates.push(d.toISOString().slice(0,10));
    sessions.push(Math.floor(Math.random()*5+1));
  }
  new Chart(document.getElementById('chart-repo-daily'), {
    type: 'bar', data: { labels: dates, datasets: [{ label: 'セッション', data: sessions, backgroundColor: 'rgba(59,130,246,0.5)', borderRadius: 3 }] },
    options: { responsive: true, maintainAspectRatio: false, scales: {
      x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MM/dd' } }, grid: { display: false } },
      y: { ticks: { stepSize: 1 } }
    }, plugins: { legend: { display: false } } }
  });

  new Chart(document.getElementById('chart-repo-contributors'), {
    type: 'bar', data: { labels: ['t.hirai', 'k.tanaka', 's.yamada'],
      datasets: [
        { label: 'セッション', data: [34, 18, 10], backgroundColor: '#3b82f6', borderRadius: 4 },
        { label: 'トークン (K)', data: [1600, 720, 480], backgroundColor: '#8b5cf6', borderRadius: 4 },
      ]}, options: { responsive: true, maintainAspectRatio: false,
      scales: { x: { grid: { display: false } }, y: { grid: { display: false } } },
      plugins: { legend: { position: 'top', labels: { boxWidth: 10 } } } }
  });
}

// === 効率分析チャート ===
function renderEfficiencyCharts() {
  var points = [];
  var colors = { opus: '#8b5cf6', sonnet: '#3b82f6', haiku: '#22d3ee' };
  for (var i = 0; i < 80; i++) {
    var model = Math.random() > 0.6 ? 'opus' : (Math.random() > 0.4 ? 'sonnet' : 'haiku');
    var turns = Math.floor(Math.random()*50+1);
    var tokens = turns * (model === 'opus' ? 12000 : model === 'sonnet' ? 8000 : 3000) * (0.5 + Math.random());
    points.push({ x: turns, y: tokens, model: model });
  }
  var datasets = ['opus','sonnet','haiku'].map(function(m) {
    return {
      label: m.charAt(0).toUpperCase()+m.slice(1),
      data: points.filter(function(p){return p.model===m}).map(function(p){return {x:p.x,y:p.y}}),
      backgroundColor: colors[m] + '99', borderColor: colors[m], borderWidth: 1, pointRadius: 5, pointHoverRadius: 8,
    };
  });

  new Chart(document.getElementById('chart-scatter'), {
    type: 'scatter', data: { datasets: datasets },
    options: { responsive: true, maintainAspectRatio: false, scales: {
      x: { title: { display: true, text: 'ターン数', color: '#64748b' }, grid: { color: 'rgba(148,163,184,0.08)' } },
      y: { title: { display: true, text: 'トークン', color: '#64748b' }, ticks: { callback: function(v) { return (v/1000).toFixed(0)+'K'; } }, grid: { color: 'rgba(148,163,184,0.08)' } }
    }, plugins: { legend: { position: 'top', labels: { boxWidth: 10 } },
      tooltip: { callbacks: { label: function(ctx) { return ctx.dataset.label + ': ' + ctx.parsed.x + ' ターン, ' + (ctx.parsed.y/1000).toFixed(1) + 'K トークン'; } } }
    } }
  });

  new Chart(document.getElementById('chart-tool-by-class'), {
    type: 'bar', data: { labels: ['Quick Fix', 'Focused Build', 'Exploration', 'Heavy Session'],
      datasets: [
        { label: 'File', data: [2.1, 5.4, 3.2, 8.1], backgroundColor: '#3b82f6', stack: 's' },
        { label: 'Code', data: [0.8, 3.2, 1.5, 5.4], backgroundColor: '#8b5cf6', stack: 's' },
        { label: 'Shell', data: [0.5, 2.1, 0.8, 4.2], backgroundColor: '#22c55e', stack: 's' },
        { label: 'Search', data: [1.2, 1.8, 4.5, 3.8], backgroundColor: '#f59e0b', stack: 's' },
      ]},
    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: {
      x: { stacked: true, title: { display: true, text: '平均ツール数/セッション', color: '#64748b' }, grid: { display: false } },
      y: { stacked: true, grid: { display: false } }
    }, plugins: { legend: { position: 'top', labels: { boxWidth: 10 } } } }
  });
}
</script>
</body>
</html>
