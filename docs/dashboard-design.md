# AI Driven Analytics - ダッシュボード設計書

> チームマネージャー / リーダーが Claude Code の利用状況を把握・管理するための
> ダッシュボードおよび履歴データ閲覧ページの設計

---

## 目次

1. [設計方針](#1-設計方針)
2. [ページ構成一覧](#2-ページ構成一覧)
3. [ナビゲーション設計](#3-ナビゲーション設計)
4. [共通レイアウトパターン](#4-共通レイアウトパターン)
5. [Page 1: 概要ダッシュボード](#5-page-1-概要ダッシュボード)
6. [Page 2: トークン利用分析](#6-page-2-トークン利用分析)
7. [Page 3: メンバー分析](#7-page-3-メンバー分析)
8. [Page 4: リポジトリ分析](#8-page-4-リポジトリ分析)
9. [Page 5: セッション履歴](#9-page-5-セッション履歴)
10. [Page 6: プロンプトフィード](#10-page-6-プロンプトフィード)
11. [共通コンポーネント仕様](#11-共通コンポーネント仕様)
12. [デザインガイドライン](#12-デザインガイドライン)
13. [API エンドポイント一覧](#13-api-エンドポイント一覧)

---

## 1. 設計方針

### 1.1 ターゲットユーザーと利用シーン

| ユーザー | 主な関心事 | 頻度 |
|----------|-----------|------|
| チームマネージャー | 月次コスト、予算消化率、チーム全体の健全性 | 週1〜月1 |
| テックリード | メンバーの活用度、ツール使用傾向、セッション品質 | 週2〜3回 |
| 個人メンバー | 自分のセッション履歴、コスト推移 | 必要時 |

### 1.2 設計原則

- **概要 → 詳細の階層構造**: ダッシュボードで異常を検知し、ドリルダウンで原因特定
- **左右分割レイアウト**: メンバー・リポジトリ・セッション分析で採用。左に一覧、右に選択項目の詳細を表示
- **アイコンレスのモダンデザイン**: 絵文字やアイコンを使わず、タイポグラフィとカラーアクセントで情報を整理
- **最小限の操作**: フィルターは全ページ共通、ページ遷移なしでコンテキスト維持

### 1.3 技術スタック（フロントエンド）

| 技術 | 用途 |
|------|------|
| EJS (サーバーサイドテンプレート) | HTML構造、ページレイアウト |
| Chart.js 4.x | 全チャート描画 |
| chartjs-adapter-date-fns | 日付軸 |
| Vanilla JS (ES5互換) | DOM操作、API呼出、状態管理 |
| CSS Custom Properties | ダーク/ライトテーマ切替 |

---

## 2. ページ構成一覧

```
+------------------------------------------------------+
|  aida analytics                                       |
+------+-----------------------------------------------+
|      |                                               |
| Nav  |  [Page 1] 概要ダッシュボード                  |
|      |  [Page 2] トークン利用分析                    |
|      |  [Page 3] メンバー分析                        |
|      |  [Page 4] リポジトリ分析                      |
|      |  [Page 5] セッション履歴                      |
|      |  [Page 6] プロンプトフィード                  |
|      |                                               |
+------+-----------------------------------------------+
```

| # | ページ | URL パス | 主目的 |
|---|--------|---------|--------|
| 1 | 概要ダッシュボード | `/` | KPI・チャート・ヒートマップで全体を把握 |
| 2 | トークン利用分析 | `/#cost` | モデル別コスト推移、トークン消費の詳細分析 |
| 3 | メンバー分析 | `/#members` | メンバー別ヒートマップ + 左右分割で個別詳細 |
| 4 | リポジトリ分析 | `/#repos` | リポジトリ別利用状況 + 左右分割で個別詳細 |
| 5 | セッション履歴 | `/#sessions` | セッション検索・フィルター + 左右分割で詳細 |
| 6 | プロンプトフィード | `/#prompt-feed` | リアルタイムのプロンプト履歴フィード |

> ハッシュベースルーティング（SPA的遷移）を採用。
> ページリロードなしでビュー切替。ブラウザの戻る/進むに対応。

---

## 3. ナビゲーション設計

### 3.1 レイアウト構造

```
+------------------------------------------------------------------+
| [aida analytics]   [期間: 2025/01/01 ~ 01/31] [Apply] [Theme]    |
+--------+---------------------------------------------------------+
| Nav    |                    Content Area                          |
|        |                                                         |
| 概要ダッシュボード |                                              |
| トークン利用分析   |                                              |
| メンバー分析       |                                              |
| リポジトリ分析     |                                              |
| セッション履歴     |                                              |
| プロンプトフィード |                                              |
|        |                                                         |
| ---    |                                                         |
| Filter |                                                         |
| Member |                                                         |
| [___v] |                                                         |
| Repo   |                                                         |
| [___v] |                                                         |
| Model  |                                                         |
| [___v] |                                                         |
+--------+---------------------------------------------------------+
```

### 3.2 サイドバーロゴ

- ロゴマーク: `aida`（18px, font-weight 800, アクセントカラー）
- サブテキスト: `ANALYTICS`（11px, 大文字, letter-spacing 2px）
- アイコンなし、テキストのみのミニマルデザイン

### 3.3 サイドナビゲーション

- ページ切替リンク（テキストのみ、アイコンなし）
- フィルターセクション（Member, Repository, Model のドロップダウン）
- アクティブページはアクセントカラーの左ボーダーで表示

### 3.4 グローバルフィルター

| フィルター | 型 | デフォルト |
|-----------|-----|----------|
| From | date | 30日前 |
| To | date | 今日 |
| Member | select | All |
| Repository | select | All |
| Model | select | All |
| プリセット | button group | 30d |

---

## 4. 共通レイアウトパターン

### 4.1 左右分割レイアウト（split-layout）

メンバー分析・リポジトリ分析・セッション分析で使用するパターン。

```
+------------------------------------------------------------------+
| [KPIカード / ヒートマップ]  (フル幅)                              |
+------------------------------------------------------------------+
|                              |                                    |
|  左パネル (split-left)       |  右パネル (split-right)            |
|  flex: 1                     |  flex: 1                          |
|                              |                                    |
|  一覧テーブル                |  選択項目の詳細                   |
|  - メンバー一覧              |  - チャート（1カラム表示）        |
|  - リポジトリ一覧            |  - メタデータ                     |
|  - セッション一覧            |  - 最近のセッション               |
|                              |                                    |
+------------------------------+------------------------------------+
```

**動作仕様**:
- 右パネルは初期状態で `display: none`（非表示）
- テーブル行クリック → 右パネルに `.open` クラスを追加し `display: block` で表示
- 同じ行を再クリック → `.open` を除去してパネルを閉じる（トグル動作）
- 右パネル内のチャートは `grid-template-columns: 1fr`（1カラム）で表示
- `position: sticky; top: 0` で右パネルをスクロール固定

**レスポンシブ**: 1200px 以下で `flex-direction: column` に切り替わり縦積みになる

```css
.split-layout { display: flex; gap: 20px; }
.split-left { flex: 1; min-width: 0; overflow-y: auto; }
.split-right {
  display: none;
  position: sticky; top: 0; align-self: flex-start;
  max-height: calc(100vh - 100px); overflow-y: auto;
}
.split-right.open { display: block; flex: 1; min-width: 0; }
.split-right .detail-grid-2 { grid-template-columns: 1fr; }
```

---

## 5. Page 1: 概要ダッシュボード

### 5.1 目的

チーム全体の Claude Code 利用状況の **健全性を一目で把握** する。

### 5.2 レイアウト

```
+------------------------------------------------------------------+
| [KPI] 総コスト | メンバー数 | セッション | 平均ターン | キャッシュ  |
+------------------------------------------------------------------+
| [Chart: 日別トークン推移]         [Chart: メンバー別コスト Top5]  |
| 積み上げ棒グラフ                   横棒グラフ                      |
+------------------------------------------------------------------+
| [Chart: ツール使用 Top5]          [Chart: 時間帯ヒートマップ]     |
| 横棒グラフ                         7x24 グリッド                  |
+------------------------------------------------------------------+
| [Chart: 生産性レーダー]           [Alert: セキュリティ]           |
| メンバー別生産性指標               bypass/異常終了/エラー率       |
+------------------------------------------------------------------+
| [Table: 最近のセッション]                                          |
+------------------------------------------------------------------+
```

### 5.3 KPI カード（5枚）

| # | KPI | 色 | 説明 |
|---|-----|----|------|
| 1 | Total Cost | blue | 期間内合計コスト + セッション数 |
| 2 | Members | green | アクティブメンバー数 |
| 3 | Sessions | purple | セッション数 + 前期比 |
| 4 | Avg Turns | amber | 平均ターン数/セッション |
| 5 | Cache Eff | blue | キャッシュ効率 (%) |

### 5.4 API 呼出

```
1. GET /api/dashboard/filters
2. GET /api/dashboard/stats
3. GET /api/dashboard/costs
4. GET /api/dashboard/members
5. GET /api/dashboard/tools
6. GET /api/dashboard/heatmap
7. GET /api/dashboard/sessions?per_page=10
8. GET /api/dashboard/security
9. GET /api/dashboard/productivity
```

---

## 6. Page 2: トークン利用分析

### 6.1 目的

コストとトークン消費の詳細な内訳を分析し、**予算管理とコスト最適化** を支援する。

### 6.2 レイアウト

```
+------------------------------------------------------------------+
| [KPI] 総コスト | 月末予測 | サブエージェント% | セッション単価    |
+------------------------------------------------------------------+
| [Chart: 日別コスト推移（モデル別積み上げ棒）]                     |
| 全幅表示                                                          |
+------------------------------------------------------------------+
| [Chart: モデル別コスト内訳]       [Chart: トークン種別内訳]       |
| ドーナツチャート                   ドーナツチャート                |
+------------------------------------------------------------------+
| [Chart: メンバー別コスト]                                          |
| 横棒グラフ（全メンバー表示）                                      |
+------------------------------------------------------------------+
| [Table: メンバー別トークン消費量テーブル]                          |
+------------------------------------------------------------------+
```

### 6.3 KPI カード（4枚）

| # | KPI | 色 | 説明 |
|---|-----|----|------|
| 1 | Total Cost | blue | 期間内合計コスト |
| 2 | Projected Cost | green | 月末コスト予測 |
| 3 | Subagent % | purple | サブエージェントコスト比率 |
| 4 | Cost / Session | amber | セッション当たり平均コスト |

### 6.4 API 呼出

```
1. GET /api/dashboard/stats
2. GET /api/dashboard/costs
3. GET /api/dashboard/members
4. GET /api/dashboard/subagents
```

---

## 7. Page 3: メンバー分析

### 7.1 目的

個人別の Claude Code 利用状況を把握し、**チーム内の活用状況の理解** を支援する。

### 7.2 レイアウト

```
+------------------------------------------------------------------+
| [Matrix: メンバー×日付 トークン数ヒートマップ]                    |
| 縦軸=メンバー, 横軸=日付, セルカラー=トークン消費量              |
+------------------------------------------------------------------+
| [Matrix: メンバー×日付 ターン・セッション数ヒートマップ]          |
| メインバリュー=ターン数, サブバリュー=セッション数               |
+------------------------------------------------------------------+
|                              |                                    |
|  [Table: メンバー一覧]      |  [Detail: メンバー詳細]            |
|  クリックで右パネルに詳細    |  日別トークン推移チャート          |
|                              |  モデル比率ドーナツ                |
|                              |  最近のセッション                  |
|                              |                                    |
+------------------------------+------------------------------------+
```

### 7.3 ヒートマップ（マトリクス）

- **トークン数ヒートマップ**: メンバー×日付でセルの色濃度がトークン消費量を表す
- **ターン・セッション数ヒートマップ**: メインバリューにターン数、サブバリュー（括弧表示）にセッション数
- `buildMatrixHeatmap()` 関数で描画。`secondaryKey` / `secondaryLabel` オプションでサブバリュー対応

### 7.4 メンバー詳細パネル（右側）

テーブル行クリックで右パネルに表示される詳細情報:

| コンポーネント | 内容 |
|--------------|------|
| ヘッダー | メンバー名（テキストのみ、アバターなし） |
| 日別トークン推移 | 折れ線チャート |
| モデル比率 | ドーナツチャート |
| 最近のセッション | セッション一覧テーブル |

### 7.5 API 呼出

```
Page Load:
  1. GET /api/dashboard/member-date-heatmap
  2. GET /api/dashboard/members

Member クリック時:
  3. GET /api/dashboard/member-detail?email=XXX
```

---

## 8. Page 4: リポジトリ分析

### 8.1 目的

リポジトリ別の AI 利用状況を把握し、**プロジェクトごとの AI 活用度** を可視化する。

### 8.2 レイアウト

```
+------------------------------------------------------------------+
| [KPI] リポジトリ数 | 総セッション | 総トークン | 総コスト          |
+------------------------------------------------------------------+
|                              |                                    |
|  [Table: リポジトリ一覧]    |  [Detail: リポジトリ詳細]          |
|  名前 / セッション数 /      |  日別セッション推移チャート        |
|  トークン / コスト           |  メンバー比率ドーナツ              |
|                              |  ブランチ別集計テーブル            |
|                              |  最近のセッション                  |
|                              |                                    |
+------------------------------+------------------------------------+
```

### 8.3 リポジトリ詳細パネル（右側）

| コンポーネント | 内容 |
|--------------|------|
| ヘッダー | リポジトリ名（テキストのみ、アイコンなし） |
| 日別セッション推移 | 折れ線チャート（セッション数 + ターン数 + トークン数） |
| メンバー比率 | ドーナツチャート |
| ブランチ別集計 | ブランチ名 + セッション数のテーブル |
| 最近のセッション | セッション一覧テーブル |

### 8.4 API 呼出

```
Page Load:
  1. GET /api/dashboard/repos

Repo クリック時:
  2. GET /api/dashboard/repo-detail?repo=XXX
```

---

## 9. Page 5: セッション履歴

### 9.1 目的

全セッションを **検索・フィルター・ソート** して閲覧し、詳細をドリルダウンする。

### 9.2 レイアウト

```
+------------------------------------------------------------------+
| [検索バー + フィルター]                                            |
+------------------------------------------------------------------+
|                              |                                    |
|  [Table: セッション一覧]    |  [Detail: セッション詳細]          |
|  Time / Member / Model /    |  KPI (Duration, Cost, Tokens等)   |
|  Duration / Cost / Repo     |  メタデータグリッド                |
|                              |  Summary                          |
|  [Pagination]                |  ターンタイムライン                |
|                              |  ファイル変更一覧                  |
|                              |  セッションイベント                |
|                              |                                    |
+------------------------------+------------------------------------+
```

### 9.3 セッション詳細パネル（右側、埋め込み形式）

セッション一覧でクリックすると、右パネルに詳細が埋め込み表示される。
他ページからのセッション詳細表示時は既存のオーバーレイサイドバーを使用。

| コンポーネント | 内容 |
|--------------|------|
| KPI カード | Duration / Cost / Tokens / Turns / Tools |
| メタデータ | Repo / Branch / CWD / Permission / End Reason |
| Summary | セッション要約テキスト |
| ターンタイムライン | ターンごとのプロンプト・ツール使用・トークン |
| ファイル変更一覧 | 操作 + ファイルパス |
| セッションイベント | コンパクション等のイベント |

### 9.4 API 呼出

```
Page Load:
  1. GET /api/dashboard/sessions?per_page=20&page=1

Session クリック時:
  2. GET /api/dashboard/sessions/:id
```

---

## 10. Page 6: プロンプトフィード

### 10.1 目的

メンバーが送信したプロンプト履歴を **リアルタイムでカード形式** で可視化し、
チームの AI 活用状況をライブモニタリングする。

### 10.2 レイアウト

```
+------------------------------------------------------------------+
| [Header: プロンプトフィード]                                      |
| [フィルター: メンバー / リポジトリ / モデル]  [一時停止ボタン]    |
+------------------------------------------------------------------+
|                                                                    |
|  [Card Feed] (max-width: 800px, 中央配置)                         |
|                                                                    |
|  +------------------------------------------------------------+   |
|  | メンバー名   相対時刻   [モデルバッジ]                      |   |
|  | border-left: 3px solid (メンバー決定的カラー)                |   |
|  |                                                              |   |
|  | プロンプト本文（先頭500文字）                                |   |
|  |                                                              |   |
|  | トークン: 45.2K  ツール: 5  リポジトリ: myapp                |   |
|  +------------------------------------------------------------+   |
|                                                                    |
|  [Card]                                                            |
|  [Card]                                                            |
|  ...                                                               |
|                                                                    |
|  [もっと読み込む]                                                  |
|                                                                    |
+------------------------------------------------------------------+
```

### 10.3 カードデザイン

- **アバターなし**: メンバー識別は `border-left: 3px solid` のカラーで表現
- カラーはメンバー名のハッシュ値から決定的に生成
- ヘッダー: メンバー名 + 相対時刻 + モデルバッジ
- 本文: プロンプトテキスト（先頭表示）
- フッター: トークン数 / ツール使用数 / リポジトリ名

### 10.4 自動更新

- **15秒間隔のポーリング** で新着プロンプトを取得
- 一時停止ボタンでポーリングを停止/再開
- 新着カードはスライドインアニメーションで表示
- カーソルベースページネーション（`before` パラメータ）

### 10.5 インタラクション

| 操作 | 動作 |
|------|------|
| カードクリック | セッション詳細サイドバーを表示 |
| 「もっと読み込む」クリック | 過去のプロンプトを追加取得 |
| 一時停止ボタン | 自動更新の停止/再開トグル |
| フィルター変更 | フィードをリセットして再取得 |

### 10.6 API

```
GET /api/dashboard/prompt-feed?limit=30&before=CURSOR
  パラメータ: limit, before (カーソル), member, repo, model
  レスポンス: {
    data: [{
      id, turnNumber, promptText, promptSubmittedAt,
      durationMs, inputTokens, outputTokens, model,
      member: { gitEmail, displayName },
      session: { id, gitRepo, gitBranch },
      toolCount
    }],
    hasMore: boolean
  }
```

---

## 11. 共通コンポーネント仕様

### 11.1 KPI カード

```
+----------------------------+
| LABEL          (11px, muted)|
| VALUE    (26px, bold)       |
| sub-text (11px, muted)      |
+----------------------------+
  border-top: 3px solid [color]
```

**仕様**:
- **アイコンなし**: タイポグラフィのみで構成
- カラーアクセント: `border-top: 3px solid` でカテゴリ色を表示
- 色クラス: `.kpi-card.blue` / `.green` / `.purple` / `.amber` / `.red`
- ラベル: 11px, 大文字, letter-spacing 0.5px
- 値: 26px, 太字
- サブテキスト: 11px, muted色
- ホバー: translateY(-2px) + shadow

### 11.2 チャートコンポーネント

- タイトル: 14px, 太字
- レスポンシブ: Chart.js `responsive: true`
- テーマ対応: `getChartThemeOptions()` で色を動的変更
- ツールチップ: カスタムフォーマット（`formatCost`, `formatCompact`）
- 右パネル内では 1カラム表示（`grid-template-columns: 1fr`）

### 11.3 テーブルコンポーネント

- ヘッダー: 11px, 大文字, letter-spacing
- セル: 13px, nowrap
- ソート: ヘッダークリックで昇降切替
- ホバー: 行背景色変更
- クリック: cursor: pointer、行全体がクリッカブル

### 11.4 マトリクスヒートマップ

`buildMatrixHeatmap()` 関数で描画する HTML テーブルベースのヒートマップ。

- 縦軸: メンバー名（またはリポジトリ名）
- 横軸: 日付
- セル: 値に応じた色の濃淡（CSS変数ベース）
- `secondaryKey` / `secondaryLabel` オプションでサブバリュー表示対応
- サブバリューは括弧付きで表示（例: `45 (3)` = 45ターン, 3セッション）

### 11.5 バッジ

| バッジ種類 | 背景色 | テキスト色 |
|-----------|--------|-----------|
| model-opus | rgba(168,85,247,0.15) | purple |
| model-sonnet | rgba(99,102,241,0.15) | accent |
| model-haiku | rgba(6,182,212,0.15) | info |
| status-success | rgba(34,197,94,0.15) | success |
| status-failure | rgba(239,68,68,0.15) | danger |

---

## 12. デザインガイドライン

### 12.1 テーマ

**ダークテーマ（デフォルト）** と **ライトテーマ** の切替をサポート。

```css
:root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: #1e293b;
    --bg-hover: #334155;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border: #334155;
    --accent: #6366f1;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #06b6d4;
    --purple: #a855f7;
}
```

### 12.2 タイポグラフィ

| 要素 | サイズ | ウェイト |
|------|--------|---------|
| ページタイトル | 22px | 700 |
| セクションタイトル | 14px | 600 |
| KPI 値 | 26px | 700 |
| KPI ラベル | 11px | 600 |
| テーブルヘッダー | 11px | 600 |
| テーブルセル | 13px | 400 |
| バッジ | 10-11px | 600 |

**フォントファミリー**:
- 本文: `-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif`
- モノスペース: `'SF Mono', 'Fira Code', monospace`

### 12.3 アイコンレスデザイン

全 UI コンポーネントからアイコン・絵文字を排除し、以下で情報を伝達:

- **カラーアクセント**: KPI カードの `border-top`、プロンプトカードの `border-left`
- **タイポグラフィ**: フォントサイズ・ウェイトの階層で情報の重要度を表現
- **カラーバッジ**: モデル・ステータスの識別
- **テキストラベル**: ナビゲーション項目はテキストのみ

### 12.4 レスポンシブ

| ブレークポイント | レイアウト変更 |
|----------------|---------------|
| > 1200px | フルレイアウト（サイドナビ + split-layout） |
| ≤ 1200px | split-layout が縦積みに変更 |
| < 600px | 1列KPI、テーブル横スクロール |

---

## 13. API エンドポイント一覧

### Dashboard API (`/api/dashboard/*`) — 18 GET エンドポイント

| # | エンドポイント | 用途 | 使用ページ |
|---|---------------|------|-----------|
| 1 | `/stats` | KPI サマリー | 概要, トークン |
| 2 | `/daily` | 日別集計 | 概要 |
| 3 | `/members` | メンバー集計 | 概要, トークン, メンバー |
| 4 | `/subagents` | サブエージェント統計 | トークン |
| 5 | `/tools` | ツール使用統計 | 概要 |
| 6 | `/costs` | モデル別コスト推移 | 概要, トークン |
| 7 | `/sessions` | セッション一覧 | 概要, セッション |
| 8 | `/sessions/:id` | セッション詳細 | セッション |
| 9 | `/heatmap` | 時間帯ヒートマップ | 概要 |
| 10 | `/security` | セキュリティ指標 | 概要 |
| 11 | `/repos` | リポジトリ集計 | リポジトリ |
| 12 | `/repo-detail` | リポジトリ個別詳細 | リポジトリ |
| 13 | `/member-detail` | メンバー個別詳細 | メンバー |
| 14 | `/repo-date-heatmap` | リポジトリ×日付ヒートマップ | リポジトリ |
| 15 | `/member-date-heatmap` | メンバー×日付ヒートマップ | メンバー |
| 16 | `/productivity` | 生産性レーダー指標 | 概要 |
| 17 | `/filters` | フィルター選択肢 | 全ページ |
| 18 | `/prompt-feed` | プロンプトフィード | プロンプトフィード |

### Hook API (`/api/hook/*`) — 6 POST エンドポイント

| # | エンドポイント | 用途 |
|---|---------------|------|
| 1 | `/session-start` | セッション開始 |
| 2 | `/prompt` | プロンプト送信 |
| 3 | `/subagent-start` | サブエージェント開始 |
| 4 | `/subagent-stop` | サブエージェント終了 |
| 5 | `/stop` | ターン完了 |
| 6 | `/session-end` | セッション終了 |
